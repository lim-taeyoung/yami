{% extends "base.html" %}

{% block content %}
{% set column_filter = column_filter if column_filter is not none else [] %}

<h1>ğŸª íŒŒíŠ¸ë„ˆë§¤ì¥ í˜„í™©</h1>

<form method="get" action="/partner-store" class="search-form">
    <div class="search-form">
        <label class="select-wrapper">
            <select name="filter_column">
                <option value="ì‚¬ë²ˆ" {% if filter_column == "ì‚¬ë²ˆ" %}selected{% endif %}>ì‚¬ë²ˆ</option> 
                <option value="ì§€ì‚¬" {% if filter_column == "ì§€ì‚¬" %}selected{% endif %}>ì§€ì‚¬</option>
                <option value="ì„¼í„°" {% if filter_column == "ì„¼í„°" %}selected{% endif %}>ì„¼í„°</option>
                <option value="ì ‘ì ì½”ë“œ" {% if filter_column == "ì ‘ì ì½”ë“œ" %}selected{% endif %}>ì ‘ì ì½”ë“œ</option>
            </select>
        </label>
        <input type="text" name="filter_value" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" value="{{ filter_value or '' }}">
        <button type="submit">ğŸ” ê²€ìƒ‰</button>
        <button type="button" onclick="location.href='/main'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <fieldset style="margin-top:10px; display: flex; flex-wrap: wrap; gap: 20px;">
        <legend>âœ… ì •ë³´ ì„ íƒí•˜ê¸°</legend>
        <label>
            <input type="checkbox" name="column_filter" value="ì‹¤ì í™•ì¸"
                   onclick="handleCheckbox(this)"
                   {% if "ì‹¤ì í™•ì¸" in column_filter %}checked{% endif %}>
            ì‹¤ì í™•ì¸
        </label>

        <label>
            <input type="checkbox" name="column_filter" value="íŒŒíŠ¸ë„ˆ ì •ë³´"
                   onclick="handleCheckbox(this)"
                   {% if "íŒŒíŠ¸ë„ˆ ì •ë³´" in column_filter %}checked{% endif %}>
            íŒŒíŠ¸ë„ˆ ì •ë³´
        </label>

        <label>
            <input type="checkbox" name="column_filter" value="ëª¨ë‘ë³´ê¸°"
                   onclick="handleCheckbox(this)"
                   {% if "ëª¨ë‘ë³´ê¸°" in column_filter %}checked{% endif %}>
            ëª¨ë‘ë³´ê¸°
        </label>
    </fieldset>
</form>

<hr>
<div class="table-wrapper">
  <div style="position: relative;">
    {{ table_html|safe }}
  </div>
</div>

<script>
function handleCheckbox(clicked) {
    const ì‹¤ì í™•ì¸ = document.querySelector('input[name="column_filter"][value="ì‹¤ì í™•ì¸"]');
    const íŒŒíŠ¸ë„ˆì •ë³´ = document.querySelector('input[name="column_filter"][value="íŒŒíŠ¸ë„ˆ ì •ë³´"]');
    const ëª¨ë‘ë³´ê¸° = document.querySelector('input[name="column_filter"][value="ëª¨ë‘ë³´ê¸°"]');

    if (clicked === ëª¨ë‘ë³´ê¸° && clicked.checked) {
        ì‹¤ì í™•ì¸.checked = false;
        íŒŒíŠ¸ë„ˆì •ë³´.checked = false;
    } else if (clicked === ì‹¤ì í™•ì¸ && clicked.checked) {
        íŒŒíŠ¸ë„ˆì •ë³´.checked = false;
        ëª¨ë‘ë³´ê¸°.checked = false;
    } else if (clicked === íŒŒíŠ¸ë„ˆì •ë³´ && clicked.checked) {
        ì‹¤ì í™•ì¸.checked = false;
        ëª¨ë‘ë³´ê¸°.checked = false;
    }
}

// í…ìŠ¤íŠ¸ ê¸¸ì´ë¥¼ ê³ ë ¤í•´ ì—°ì†ì„± ì—¬ë°± ì´ˆê¸°í™”
function adjustStickyColumnWidths() {
    const colIndices = [3, 4, 5, 6];
    const table = document.querySelector(".table");
    if (!table) return;

    const rows = table.querySelectorAll("tr");
    const widths = [];

    colIndices.forEach((colIdx) => {
        let maxWidth = 0;
        rows.forEach(row => {
            const cell = row.cells[colIdx - 1];
            if (cell) {
                const textLength = cell.textContent.trim().replace(/\s+/g, '').length;
                const width = textLength * 10 + 40;
                if (width > maxWidth) maxWidth = width;
            }
        });
        widths.push(maxWidth);
    });

    let leftOffset = 0;
    colIndices.forEach((colIdx, i) => {
        const width = widths[i];
        rows.forEach(row => {
            const cell = row.cells[colIdx - 1];
            if (cell) {
                cell.style.minWidth = `${width}px`;
                cell.style.maxWidth = `${width}px`;
                cell.style.width = `${width}px`;
                cell.style.left = `${leftOffset}px`;
                cell.style.position = 'sticky';
                cell.style.zIndex = 10;

                if (cell.tagName === 'TH') {
                    cell.style.background = '#f2f2f2';
                } else {
                    cell.style.background = '#fff';
                }
            }
        });
        leftOffset += width;
    });
}

window.addEventListener("load", adjustStickyColumnWidths);
</script>

<style>
.table th,
.table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.table th:nth-child(3),
.table td:nth-child(3),
.table th:nth-child(4),
.table td:nth-child(4) {
    padding-left: 0.1px !important;
    padding-right: 0.1px !important;
}

.search-form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    font-size: 28px;
    width: 100%;
}

.search-form select,
.search-form input[type="text"],
.search-form button {
    height: 60px;
    font-size: 24px;
    padding: 10px;
    flex: 1 1 auto;
}

.select-wrapper {
    flex: 2;
    min-width: 150px;
}

.search-form input[type="text"] {
    flex: 6;
    min-width: 200px;
}

.search-form button {
    flex: 2;
    min-width: 120px;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 20px;
    border-top: 2px solid #333;
}

.table {
    border-collapse: collapse;
    min-width: 1000px;
    width: max-content;
    margin: auto;
    font-size: 20px;
    table-layout: fixed;
}

.table th,
.table td {
    border: 1px solid #ccc;
    padding: 1px 5px;
    height: 32px;
    text-align: center;
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: ellipsis;
}

.table th:nth-child(1), .table td:nth-child(1),
.table th:nth-child(2), .table td:nth-child(2) {
    display: none;
}


.table th {
    background-color: #f2f2f2 !important;
    color: #000;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 5;
}

input[type="checkbox"] {
    width: 23px;
    height: 23px;
    transform: scale(1.4);  /* ì¢€ ë” í‚¤ìš°ê³  ì‹¶ë‹¤ë©´ ìˆ«ìë¥¼ ëŠ˜ë¦¬ë©´ ë©ë‹ˆë‹¤ */
    margin-right: 10px;     /* í…ìŠ¤íŠ¸ì™€ì˜ ê°„ê²© */
}


.table td:nth-child(3) { left: 0; width: 40px; min-width: 40px; }
.table td:nth-child(4) { left: 40px; width: 40px; min-width: 40px; }
.table td:nth-child(5) { left: 80px; width: 120px; min-width: 120px; }
.table td:nth-child(6) { left: 200px; width: 120px; min-width: 120px; }

.table th:nth-child(3) { left: 0; width: 40px; min-width: 40px; }
.table th:nth-child(4) { left: 40px; width: 40px; min-width: 40px; }
.table th:nth-child(5) { left: 80px; width: 120px; min-width: 120px; }
.table th:nth-child(6) { left: 200px; width: 120px; min-width: 120px; }


.table tr.sum-row td {
    background-color: #e0f7fa !important;
    font-weight: bold !important;
    color: #000 !important;
}

.table tr.sum-row td:nth-child(-n+6) {
    color: transparent !important;
}

@media (max-width: 768px) {
    .search-form {
        flex-direction: row;
        flex-wrap: wrap;
    }
    .search-form > * {
        flex: 1 1 100%;
    }
    .table {
        font-size: 12px;
    }
    .table th,
    .table td {
        padding: 4px 6px;
        white-space: normal !important;
        overflow: visible !important;
    }
}
</style>
{% endblock %}