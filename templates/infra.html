{% extends "base.html" %}
{% block content %}

<h1>ğŸŒ ì¸í”„ë¼ í˜„í™© 
    <button type="button" style="float: right;" onclick="location.href='/main'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
</h1>

<!-- âœ… ì²´í¬ë°•ìŠ¤ ì˜ì—­ (ìœ„) -->
<form method="get" action="/infra" class="search-form">
    <fieldset style="display: flex; flex-wrap: wrap; gap: 15px;">
        <legend>ğŸ“Œ ìœ í˜• ì„ íƒ</legend>
        {% for label in sheet_options %}
        <label>
            <input type="checkbox" name="selected_sheets" value="{{ label }}"
                   {% if label in selected_sheets %}checked{% endif %}
                   onclick="handleCheckboxClick(this)">
            {{ label }}
        </label>
        {% endfor %}
    </fieldset>


    <!-- âœ… ê²€ìƒ‰ ì˜ì—­ (ì•„ë˜) -->
    <div class="search-row">
        <select name="filter_column" class="search-dropdown">
            <option value="ì‚¬ë²ˆ" {% if filter_column == "ì‚¬ë²ˆ" %}selected{% endif %}>ì‚¬ë²ˆ</option> 
            <option value="ì§€ì‚¬" {% if filter_column == "ì§€ì‚¬" %}selected{% endif %}>ì§€ì‚¬</option>
            <option value="ì„¼í„°" {% if filter_column == "ì„¼í„°" %}selected{% endif %}>ì„¼í„°</option>
            <option value="ì ‘ì ì½”ë“œ" {% if filter_column == "ì ‘ì ì½”ë“œ" %}selected{% endif %}>ì ‘ì ì½”ë“œ</option>
        </select>
        <input type="text" name="filter_value" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" 
               value="{{ filter_value or '' }}" class="search-input">
        <button type="submit" class="search-button">ğŸ” ê²€ìƒ‰</button>
    </div>
</form>

<hr>

<!-- âœ… ìš”ì•½ í…Œì´ë¸” (í•­ìƒ ë‹¤ì„¯ ê°€ì§€ ìœ í˜•) -->
<div class="summary-table" style="margin-top: 20px;">
    <h2>ğŸ“Š ìš”ì•½ í˜„í™©</h2>
    <table class="table table-summary">
        <thead>
            <tr>
                <th>ìœ í˜•</th>
                <th>ëŒ€ìƒ ì ìˆ˜</th>
                <th>ê°€ë™ ì ìˆ˜</th>
                <th>ë¯¸ê°€ë™ ì ìˆ˜</th>
                <th>ê°€ë™ë¥ </th>
            </tr>
        </thead>
        <tbody>
            {% for summary in summary_data %}
            <tr>
                <td>{{ summary.label }}</td>
                <td>{{ summary.total_points }}</td>
                <td>{{ summary.active_points }}</td>
                <td>{{ summary.inactive_points }}</td>
                <td>{{ summary.active_rate }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<hr>

<!-- âœ… ì¶œë ¥ í…Œì´ë¸” -->
{% if tables %}
    {% for label, html in tables.items() %}
        <h2 style="margin-top: 40px;">ğŸ“„ {{ label }}</h2>
        <div class="table-wrapper">
            <div class="table-container" style="--font-size: 16px; --row-height: 40px;">
                {{ html | safe }}
            </div>
        </div>
    {% endfor %}
{% else %}
    <p style="margin-top: 30px;">âœ… ìœ í˜•ì„ ì„ íƒí•˜ê³  ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
{% endif %}



<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".table-container table").forEach(table => {
        const headers = table.querySelectorAll("th");
        let gadowIndex = -1;
        let separatorIndex = -1;

        headers.forEach((header, index) => {
            const headerText = header.innerText.trim();
            
            // âœ… "êµ¬ë¶„ì" ì»¬ëŸ¼ ìë™ ìˆ¨ê¹€
            if (headerText === "êµ¬ë¶„ì") {
                separatorIndex = index;
                header.style.display = "none";
            }

            // âœ… "ê°€ë™ì—¬ë¶€" ì»¬ëŸ¼ ì¸ë±ìŠ¤ í™•ì¸
            if (headerText.includes("ê°€ë™ì—¬ë¶€")) {
                gadowIndex = index;
            }
        });

        // âœ… ê° í–‰ì—ì„œ ì²˜ë¦¬
        table.querySelectorAll("tr").forEach(row => {
            if (separatorIndex >= 0) {
                const cell = row.children[separatorIndex];
                if (cell) {
                    cell.style.display = "none";
                }
            }

            // âœ… "ê°€ë™ì—¬ë¶€" ì»¬ëŸ¼ O í‘œì‹œ ìƒ‰ìƒ ë³€ê²½
            if (gadowIndex >= 0) {
                const cell = row.children[gadowIndex];
                if (cell && cell.innerText.trim().toUpperCase() === "O") {
                    cell.classList.add("highlight-green");
                }
            }
        });
    });
});

// âœ… ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ë‹¤ë¥¸ ì²´í¬ë°•ìŠ¤ ìë™ í•´ì œ
function handleCheckboxClick(clicked) {
    document.querySelectorAll('input[name="selected_sheets"]').forEach(checkbox => {
        if (checkbox !== clicked) checkbox.checked = false;
    });
}
</script>

<style>
/* âœ… ê°•ì œ ì ìš©ë˜ëŠ” ì—°ë‘ìƒ‰ ìŠ¤íƒ€ì¼ (ìš°ì„  ì ìš©) */
.highlight-green {
    background-color: #ccf392 !important;
    color: #000 !important;
    font-weight: bold !important;
}
/* âœ… ì‚¬ë²ˆ/ì´ë¦„ ì»¬ëŸ¼ ìë™ ìˆ¨ê¹€ */
.table-container table th:nth-child(1),
.table-container table td:nth-child(1),
.table-container table th:nth-child(2),
.table-container table td:nth-child(2) {
    display: none;
}


/* âœ… ê²€ìƒ‰ ì˜ì—­ ìŠ¤íƒ€ì¼ í†µì¼ */
.search-row {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap;
    margin-top: 15px;
}

.search-dropdown, .search-input, .search-button {
    height: 40px;
    font-size: 16px;
}

.table-container table {
    font-size: var(--font-size, 16px);
    width: 100%;
}

.table-container table tr {
    height: var(--row-height, 40px);
}

/* âœ… ìš”ì•½ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.summary-table {
    margin-top: 10px; /* ìƒë‹¨ ì—¬ë°± (ê¸°ì¡´ 20px â†’ 10pxìœ¼ë¡œ ì¤„ì„) */
    font-size: 20px;  /* í°íŠ¸ í¬ê¸° 20px */
    line-height: 1.2; /* ì¤„ê°„ê²© ì¡°ì ˆ (ê¸°ë³¸ê°’ë³´ë‹¤ ì‚´ì§ ì¤„ì„) */
}

.summary-table th, 
.summary-table td {
    padding: 6px 10px; /* ì…€ ìƒí•˜ ì—¬ë°± ì¤„ì„ */
    text-align: center;
}

/* âœ… ë³¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.table-container table {
    font-size: 20px; /* í°íŠ¸ í¬ê¸° 20px */
    width: 100%;
    margin-top: 10px; /* ìƒë‹¨ ì—¬ë°± (ê¸°ì¡´ 40px â†’ 10pxìœ¼ë¡œ ì¤„ì„) */
}

.table-container table th, 
.table-container table td {
    padding: 6px 10px; /* ì…€ ìƒí•˜ ì—¬ë°± ì¤„ì„ */
    text-align: center;
}

.table-container table tr {
    height: auto; /* ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ (ì½˜í…ì¸ ì— ë§ê²Œ) */
}

.search-row {
    display: flex;
    width: 100%;
    gap: 0; /* ìš”ì†Œ ì‚¬ì´ ê°„ê²© ì œê±° (í•„ìš” ì‹œ margin ì‚¬ìš©) */
    margin-top: 15px;
}

.search-dropdown,
.search-input,
.search-button {
    flex: 1;
    height: 40px;
    font-size: 16px;
    box-sizing: border-box; /* padding í¬í•¨í•œ width ê³„ì‚° */
    margin-right: 5px; /* ê° ìš”ì†Œ ê°„ ì•½ê°„ì˜ ê°„ê²© */
}

/* ë§ˆì§€ë§‰ ìš”ì†ŒëŠ” ì˜¤ë¥¸ìª½ ì—¬ë°± ì œê±° */
.search-button {
    margin-right: 0;
}

</style>

{% endblock %}
